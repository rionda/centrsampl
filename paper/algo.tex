\section{Algorithm}\label{sec:algo}
In this section we present our algorithm to compute a set of approximations for the
betweenness centrality of all vertices in a graph through sampling, with
probabilistic guarantees on the quality of the approximations.

The intuition behind the algorithm is the following. Given a graph $G=(V,E)$
with vertex-diameter $\Delta_g$ and two parameters $\varepsilon,\delta\in(0,1)$ we first compute a sample
size $k$ using~\eqref{eq:vceapprox} with
$d=\lfloor\log_2(\Delta_G-2)\rfloor+1$:
\begin{equation}\label{eq:samplesize}
k=\frac{c}{\varepsilon^2}\left(\lfloor\log_2(\Delta_G-2)\rfloor+1+\ln\frac{1}{\delta}\right)\enspace.
\end{equation}
The sample size is sufficient to ensure
to achieve the desired accuracy (expressed through $\varepsilon$) with the
desired confidence (expressed through $1-\delta$). Then the algorithm builds a
sample $S$ of $k$ shortest path from $\mathbb{S}_G$ by sampling them according to
the probability distribution $\prob_G$ defined on $\mathbb{S}_G$ as follows:
given a shortest path $p_{uv}\in\mathbb{S}_G$ between a pair of vertices
$(u,v)\in V\times V$, 
\[
\prob_G(p_{uv})=\frac{1}{\binom{n}{2}|\mathcal{S}_{uv}|}\enspace.%=\frac{2}{n(n-1)|\mathcal{S}_{uv}|}\enspace.
\]
Sampling according to $\prob_G$ can be achieved by first picking a pair of distinct vertices $(u,v)$
uniformly at random, computing the set $\mathcal{S}_{uv}$ of all the shortest
paths between $u$ and $v$, and selecting one of these shortest paths uniformly
at random. The estimation $\tilde\betw(v)$ of the betweenness centrality of each
vertex $v\in V$ is obtained by computing the fraction of shortest paths in $S$
that $v$ is internal to and de-normalizing it: 
\[
\tilde\betw(v) = \binom{n}{2}\frac{1}{k}\sum_{p\in S}
\mathds{1}_{\mathsf{Int}(p)}(v) = \binom{n}{2}\frac{1}{k}\sum_{p\in S}
\mathds{1}_{\mathcal{T}_v}(p)\enspace.
\]
Algorithm \ref{alg:algorithm} presents the pseudocode.
\begin{algorithm}[ht]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}
  \SetKwFunction{VertexDiameter}{getVertexDiameter}
  \SetKwFunction{SamplePair}{sampleVertexPair}
  \SetKwFunction{SampleUniform}{sampleUniformPath}
  \SetKwFunction{PairShortestPaths}{computeAllShortestPaths}
   \DontPrintSemicolon
  %\dontprintsemicolon
  \Input{a graph $G=(V,E)$ with $|V|=n$, real values $\varepsilon,\delta\in(0,1)$}
  \Output{A set of approximations }
  $\Delta_G\leftarrow$\VertexDiameter{G}\label{alg:diamcomp}\; 
  $k\leftarrow (c/\varepsilon^2)(\lfloor\log_2(\Delta_G-2)\rfloor+\ln(1/\delta))$\;
  $S\leftarrow\emptyset$\;
  \For{$i\leftarrow 1$ to $k$} {
  $(u,v)\leftarrow$\SamplePair{$G$}\;
  $\mathcal{S}_{uv}\leftarrow$\PairShortestPaths{$(u,v)$}\;
  $s\leftarrow$\SampleUniform{$\mathcal{S}_{uv}$}\;
  $S\leftarrow S\cup\{s\}$\;
  }
  \For{$v\in V$} {
  $\tilde\betw(v)\leftarrow\binom{n}{2}\sum_{p\in
  S}\mathds{1}_{\mathsf{Int}(p)}(v)$\;
  }
  \Return{$\{\tilde\betw(v), v\in V\}$}
  \caption{Computes approximations $\tilde\betw(v)$ of the betweenness
  centrality $\betw(v)$ for all vertices $v\in V$.}
  \label{alg:algorithm}
\end{algorithm}

The algorithm we describes offers probabilistic guarantees on the quality of all
approximations of the betweenness centrality.
\begin{lemma}\label{lem:correctness}
  With probability at least $1-\delta$, all the approximations computed by the
  algorithm are within $\varepsilon\binom{n}{2}$ from their real value:
  %The algorithm computes a set of approximations $\tilde\betw(v)$ for each $v\in
  %V$ such that
  \[
  \Pr\left(\exists v\in V \mbox{ s.t. }
  |\betw(v)-\tilde\betw(v)|>\varepsilon\binom{n}{2}\right)<\delta\enspace .
  \]
\end{lemma}

\begin{proof}
  Consider the range set $\range_G$ and the probability distribution $\prob_G$.
  For $k$ as in~\eqref{eq:samplesize}, the sample $S$ is a
  $\varepsilon$-approximation to $(\range_G,\prob_G)$ with probability at least
  $1-\delta$. Suppose that this is indeed the case, then from
  Def.~\ref{def:eapprox} and the definition of $\range_G$ we have that
  \[
  \left|\prob_G(\mathcal{T}_v) - \frac{1}{k}\sum_{p\in
  S}\mathds{1}_{\mathcal{T}_v}(p)\right|=\left|\prob_G(\mathcal{T}_v) -
  \frac{1}{\binom{n}{2}}\tilde\betw(v)\right|\le\varepsilon, \forall v\in
  V\enspace.
  \]
  From the definition of $\prob_G$ we have
  \[
  \prob_G(\mathcal{T}_v)=\frac{1}{\binom{n}{2}}\sum_{p_{uw}\in\mathcal{T}_v}\frac{1}{|\mathcal{S}_{uw}|}=\frac{1}{\binom{n}{2}}\betw(v),
  \]
  which concludes the proof.
\end{proof}

\paragraph{Unique shortest paths case.} When the graph $G$ is undirected and
there is an unique shortest path between each pair of node, then one can apply
Lemma~\ref{lem:vcdimuppboundunique} and obtain a smaller sample size
\[ k= \frac{c}{\varepsilon^2}\left(3+\ln\frac{1}{\delta}\right)
\]
to approximate the betweenness centralities of all the vertices. Unique shortest
paths are common in or even enforced in road networks~\citep{GeisbergerSS08} by
slightly perturbing the edge weights or having a deterministic tie breaking
policy.

\subsection{Approximating the diameter}\label{sec:diam}
The algorithm presented in the previous section requires the knowledge (or the
computation) of the vertex-diameter $\Delta_G$) of the graph $G$ (line
\ref{alg:diamcomp} of Alg.~\ref{alg:algorithm}). Computing $\Delta_G$ exactly
can be done by finding the shortest paths between all pair of vertices in $V$
and computing the maximum size. This can be done in time \XXX. Such an exact
computation would defeat our purposes, because once we have all the shortest
paths, we can compute the betweenness of all the nodes exactly. Given that
Thm.~\ref{thm:eapprox} only requires an upper bound to the VC-dimension of the
range set, an upper bound to the vertex-diameter would be sufficient for our
purposes, provided its computation is fast and it does not result in a much
larger sample size than if we used the exact value for $\Delta_G$. There are
known algorithms to approximate the diameter of a
graph~\citep{AingwordCIM99,BoitmanisFL06,RodittyW12}, with various running times
and quality of approximations.

For our case, if $G$ is \emph{undirected} and \emph{all the weights are
unitary}, a $2$-approximation to $\Delta_G$ is sufficient and can be computed in
time \XXX by selecting a vertex $v\in V$ uniformly at random, computing the
shortest paths from $v$ to all other vertices in $V$, and taking
$\tilde\Delta_G$ to be the sum of the sizes of the two longest shortest paths
from $v$ to two distinct other nodes $u$ and $w$. 

\begin{lemma}\label{lem:diam}
  $\Delta_G\le\tilde\Delta_G\le 2\Delta_G$.
\end{lemma}
\begin{proof}
  Let $p_{vu}$ be the shortest path between $v$ and $u$ and analogously
  $p_{vw}$. We have $\tilde\Delta_G\le 2\Delta_G$ because
  $|p_{vu}|,|p_{vw}|\le\Delta_G$, so $|p_{vu}|+|p_{vw}|\le 2\Delta_g$. To see
  that $\tilde\Delta_G\ge\Delta_G$, consider a pair of nodes $x$ and $z$ such
  that the size of a shortest path between $x$ and $z$ is equal to $\Delta_G$.
  Let $p_{xv}$ be a shortest path between $x$ and $v$ and let $p_{vz}$ be a
  shortest path between $v$ and $z$. 
  Then (by the triangle inequality? \XXX)
  \[
  |p_{xv}|+|p_{vz}|=|p_{vx}|+|p_{vz}|\ge\Delta_G\enspace.
  \]
  It is easy to see that $|p_{vu}|+|p_{vw}|\ge|p_{vx}|+|p_{vz}|$ because the
  vertices $u$ and $w$ are chosen so that to maximize this sum. Hence
  \[
  \tilde\Delta_G = |p_{vu}|+|p_{vw}| \ge\Delta_G\enspace.\qedhere
  \]
\end{proof}

The impact of using $\tilde\Delta_G$ when computing the sample size $k$ is that
the sample will contain at most $c/\varepsilon^2$ more paths than if we used the
exact value $\Delta_G$. The computation of $\tilde\Delta_G$ has no (\XXX or
minimal) impact on the running time of our algorithm: once the $\Delta_G$ has
been computed, we can sample another node $u\neq v$ and then sample one of the
(already computed) shortest paths between $v$ and $v$ and use this path as first
element of the sample.

\subsection{Discussion}
\XXX TBD: running time, worst case, comparison with best previous work.

\citet{BrandesP07} present an algorithm that also uses sampling to approximate
the betweenness centrality of all the vertices of the graph. The algorithm
create a sample $S=\{v_1,\dotsc,v_k\}$ of $k$ vertices drawn uniformly at random 
and computes all the shortest paths between each $v_i$ to all other vertices in
the graph. The estimation $\tilde\betw'(u)$ for the betweenness centrality
$\betw(u)$ is
\[ 
\tilde\betw'(u)= \frac{n}{k}\sum_{v_i\in S}\sum_{w\neq v_i,w\neq
u}\sum_{p\in\mathcal{S}_{v_iw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{v_iw}|},
\]
As it was for our algorithm, the key ingredient to ensure a correct
approximation for the betweenness centrality is the computation of the sample
size $k$. Inspired by the work of~\citet{EppsteinW04}, \citet{BrandesP07} rely
on the following classical result by~\citet{Hoeffding63} for their computation
of $k$.

\begin{theorem}[\citep{Hoeffding63}]
  Let $X_1,X_2,\dotsc,X_k$ be a sequence of independent random variables
  such that $a_i\leq X_i\leq b_i$. Then for any $\xi > 0$
  \begin{equation}\label{eq:hoeffding}
    \Pr\left(\frac{|X_1+\dotsb+X_k|}{k}-\mathbf{E}\left[\frac{|X_1+\dotsb+X_k|}{k}\right]|\geq
    \xi\right)\leq 2e^{-2k^2\xi^2/\sum_{i=1}^{k}(b_{i}-a_{i})^2}\enspace.
  \end{equation}
\end{theorem}

\citet{BrandesP07} use this result to compute a sample size $k$ sufficient to ensure that, for
a fixed vertex $u$,
\[ 
\Pr\left(|\betw(u)-\tilde\betw'(u)|>\varepsilon\binom{n}{2}\right)<\frac{\delta}{n}\enspace.
\]
In their setting $\xi=\varepsilon\binom{n}{2}$ and there is a variable $X_i$ for
each vertex $v_i$ in the sample:
\[ 
X_i=n\sum_{w\neq v_i,w\neq
u}\sum_{p\in\mathcal{S}_{v_iw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{v_iw}|}\enspace
.
\]
It is easy to see that $0\le X_i\le n(n-2)$. Moreover,
\begin{align*}
\mathbf{E}\left[\frac{|X_1+\dotsb+X_k|}{k}\right] &=
\frac{n}{k}\mathbf{E}\left[\sum_{v_i\in S}\sum_{w\neq v_i,w\neq
u}\sum_{p\in\mathcal{S}_{v_iw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{v_iw}|}\right]
=\frac{n}{k}\sum_{v\in V}\mathbf{E}\left[Y_v\sum_{w\neq v,w\neq
u}\sum_{p\in\mathcal{S}_{vw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{vw}|}\right] =
\\
&=\frac{n}{k}\sum_{v\in V}\mathbf{E}[Y_v]\sum_{w\neq v,w\neq
u}\sum_{p\in\mathcal{S}_{vw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{vw}|}
=\frac{n}{k}\sum_{v\in V}\frac{k}{n}\sum_{w\neq v,w\neq
u}\sum_{p\in\mathcal{S}_{vw}}\frac{\mathds{1}_{\mathsf{Int}(p)}(u)}{|\mathcal{S}_{vw}|}
= \betw(u),
\end{align*}
where $Y_v$ is a Bernoulli random variable taking value 1 if $v\in S$, and 0
otherwise, so $\Pr(Y_v=1)=k/n$.

Plugging these values in~\eqref{eq:hoeffding}, we have
\[
\Pr\left(|\betw(u)-\tilde\betw'(u)|>\varepsilon\binom{n}{2}\right)\leq
2e^{-2k^2\varepsilon^2\left(\frac{n(n-1)}{2}\right)^2/kn^2(n-2)^2}=2e^{-k\epsilon^2(n-1)^2/2(n-2)^2}\enspace.
\]
We want this probability to be at most $\delta/n$, so we need a sample of size
\[
k\geq \frac{2(n-2)^2}{\varepsilon^2(n-1)^2}\left(\ln n
+\ln\frac{1}{\delta} +\ln 2\right)\enspace.
\]
An application of the union bound over the $n$ vertices ensures a uniform guarantee on the quality of
all the estimation, with probability at least $1-\delta$.

